#!/usr/bin/env bash
# m(utt) im(proved)
set -euo pipefail

DROPBOX_DOWNLOADS=$HOME/Dropbox/mail_downloads
if [ -d "$DROPBOX_DOWNLOADS" ]; then
  cd "$DROPBOX_DOWNLOADS"
elif [ -d "$HOME/Downloads" ]; then
  cd "$HOME/Downloads"
fi

mkdir -p "$HOME/.mutt/temp"

mkdir -p "$HOME/var/log"
# run once to make sure that the yubikey and such work
offlineimap
while true      # run forever
do
    mail-sync
    #mail-copy
    sleep 600   # I don't need to check that often. I can always manually check
done &          # run loop in background
LOOP_PID=$!     # copy PID of loop
mutt            # run mutt in foreground (and waits for mutt to exit)

kill $LOOP_PID              # these two lines are a cool trick to kill the
wait $LOOP_PID 2>/dev/null  # infinite loop and hide the error that it generates

mail-sync       # sync mail once more after mutt exits
mail-backup     # copy maildir as-is on exit
exit 0          # force script to exit "cleanly"
